<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vi Chất Cho Mẹ và Bé - So Sánh Vitamin Tốt Nhất</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="So sánh 20+ sản phẩm Vitamin D3K2 cho trẻ em tại Việt Nam. Tìm sản phẩm phù hợp với bộ lọc thông minh và tư vấn AI miễn phí.">
    <meta name="keywords" content="vitamin D3K2, vitamin cho trẻ em, so sánh vitamin, tăng chiều cao, bổ sung canxi">
    
    <!-- Import Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Chart.js for enhanced charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #d4a574 0%, #b8860b 25%, #cd853f 50%, #daa520 75%, #f4a460 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header-glass {
            background-color: rgba(205, 133, 63, 0.8);
            backdrop-filter: blur(10px);
        }

        .gradient-text {
            background: linear-gradient(135deg, #b8860b 0%, #cd853f 50%, #daa520 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }
        
        /* Product card selected state */
        .product-card.selected {
            border: 2px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Loading spinner */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #10b981;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
         /* Style cho accordion filter */
        details > summary {
            cursor: pointer;
            font-weight: 600;
            color: #f3f4f6; /* text-gray-100 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        details > summary::after {
            content: '›';
            transform: rotate(90deg);
            transition: transform 0.2s;
            font-size: 1.5em;
        }
        details[open] > summary::after {
            transform: rotate(-90deg);
        }
        .comparison-bar {
            transition: width 0.5s ease-in-out;
        }

        /* NEW: Underline sweep effect */
        .underline-reveal {
            position: relative;
            display: inline-block;
            color: #FFF8E1;
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .underline-reveal::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px; /* Thinner line */
            bottom: -8px;
            left: 0;
            background-color: #FFECB3;
            transform: scaleX(0);
            animation: sweep-underline 3s ease-in-out infinite;
            animation-delay: 1s;
        }

        @keyframes sweep-underline {
            0% {
                transform: scaleX(0);
                transform-origin: left;
            }
            45% {
                transform: scaleX(1);
                transform-origin: left;
            }
            55% {
                transform: scaleX(1);
                transform-origin: right;
            }
            100% {
                transform: scaleX(0);
                transform-origin: right;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header with Glass Effect -->
    <header class="header-glass sticky top-0 z-40 border-b border-white/20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-amber-600 to-yellow-700 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">
                        Vi Chất Cho Mẹ và Bé
                    </h1>
                </div>
                <nav class="hidden md:flex space-x-6 text-white/80 font-medium items-center">
                    <a href="#products" class="hover:text-white transition-colors">Sản phẩm</a>
                    <div class="relative" id="compare-menu-container">
                        <button id="compare-btn" class="px-4 py-2 bg-gradient-to-r from-amber-600 to-yellow-700 rounded-xl hover:shadow-lg transition-all duration-300 flex items-center space-x-2 opacity-50" disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>So sánh (<span id="compare-count">0</span>)</span>
                        </button>
                        <div id="compare-dropdown" class="hidden absolute top-full mt-2 w-56 rounded-xl glass-effect text-white p-2 z-50">
                            <a href="#" data-compare-type="dosage" class="block px-4 py-2 text-sm hover:bg-white/10 rounded-lg">So sánh liều dùng</a>
                            <a href="#" data-compare-type="cost" class="block px-4 py-2 text-sm hover:bg-white/10 rounded-lg">So sánh chi phí/ngày</a>
                            <a href="#" data-compare-type="k2" class="block px-4 py-2 text-sm hover:bg-white/10 rounded-lg">So sánh hàm lượng K2</a>
                        </div>
                    </div>
                    <a href="expert.html" class="hover:text-white transition-colors">Chuyên gia</a>
                </nav>
                <button class="md:hidden text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="relative py-20 overflow-hidden">
        <div class="container mx-auto px-4 text-center">
            <div class="floating-animation">
                <h2 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-6 leading-tight">
                    <span class="text-white/90">Hiểu đúng nhu cầu,</span><br>
                    <span class="underline-reveal">mẹ an tâm, con an toàn</span>
                </h2>
                <p class="text-lg md:text-xl text-white/80 max-w-3xl mx-auto mb-8 leading-relaxed">
                    Tìm sản phẩm tốt nhất cho con với công cụ so sánh thông minh, 
                    biểu đồ trực quan và tư vấn AI miễn phí từ chuyên gia dinh dưỡng.
                </p>
                 <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <button id="ai-consult-btn" class="px-8 py-4 bg-gradient-to-r from-amber-600 to-yellow-700 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span>Tư Vấn AI Miễn Phí</span>
                    </button>
                    <button onclick="document.getElementById('products').scrollIntoView({behavior: 'smooth'})" class="px-8 py-4 glass-effect text-white font-semibold rounded-2xl hover:bg-white/20 transition-all duration-300">
                        Xem Sản Phẩm
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- NEW: Product Categories Section -->
    <section id="product-categories" class="container mx-auto px-4 md:px-8 -mt-16 relative z-10">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Card 1: Xương, Răng (Active) -->
            <div class="glass-effect p-6 rounded-3xl text-white card-hover border-2 border-emerald-400 shadow-lg flex flex-col justify-between">
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 mb-4 bg-white/20 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-emerald-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
                        </svg>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Hỗ trợ Xương, Răng & Chiều cao</h3>
                    <p class="text-sm text-white/70 mb-4">Vitamin D3, K2, Canxi và các khoáng chất thiết yếu.</p>
                </div>
                <a href="#products" class="font-semibold text-emerald-300 hover:text-white text-center">Xem chi tiết ↓</a>
            </div>
            <!-- Card 2: Não bộ -->
            <div class="glass-effect p-6 rounded-3xl text-white card-hover opacity-70 flex flex-col justify-between">
                 <div class="text-center">
                    <div class="mx-auto w-16 h-16 mb-4 bg-white/20 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-cyan-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                        </svg>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Hỗ trợ Phát triển Não bộ & Thị lực</h3>
                    <p class="text-sm text-white/70 mb-4">DHA, Omega-3, và các dưỡng chất cho trí thông minh.</p>
                </div>
                <span class="font-semibold text-white/50 text-center">Sắp ra mắt</span>
            </div>
            <!-- Card 3: Đề kháng -->
            <div class="glass-effect p-6 rounded-3xl text-white card-hover opacity-70 flex flex-col justify-between">
                 <div class="text-center">
                    <div class="mx-auto w-16 h-16 mb-4 bg-white/20 rounded-full flex items-center justify-center">
                       <svg class="w-8 h-8 text-rose-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                        </svg>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Tăng cường Sức đề kháng & Tiêu hóa</h3>
                    <p class="text-sm text-white/70 mb-4">Vitamin C, Kẽm, Probiotics và vitamin tổng hợp.</p>
                </div>
                <span class="font-semibold text-white/50 text-center">Sắp ra mắt</span>
            </div>
            <!-- Card 4: Mẹ & Bé -->
            <div class="glass-effect p-6 rounded-3xl text-white card-hover opacity-70 flex flex-col justify-between">
                 <div class="text-center">
                    <div class="mx-auto w-16 h-16 mb-4 bg-white/20 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-amber-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.321h5.365c.414 0 .584.536.283.766l-4.34 3.16a.563.563 0 0 0-.182.635l1.63 5.85c.128.463-.386.848-.794.536l-4.82-3.522a.563.563 0 0 0-.666 0l-4.82 3.522c-.408.312-.922-.073-.794-.536l1.63-5.85a.563.563 0 0 0-.182-.635l-4.34-3.16c-.301-.23-.131-.766.283-.766h5.365a.563.563 0 0 0 .475-.321L11.48 3.5Z" />
                        </svg>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Hỗ trợ Sức khỏe Phụ nữ & Thai kỳ</h3>
                    <p class="text-sm text-white/70 mb-4">Sắt, Axit Folic, và các vitamin cho mẹ bầu & sau sinh.</p>
                </div>
                <span class="font-semibold text-white/50 text-center">Sắp ra mắt</span>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-8 mt-16">
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Enhanced Filter Sidebar -->
            <aside class="w-full lg:w-1/4">
                <div class="glass-effect p-6 rounded-3xl sticky top-24 fade-in">
                    <h3 class="font-bold text-2xl mb-6 text-white flex items-center">
                        <svg class="w-6 h-6 mr-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        Bộ Lọc Thông Minh
                    </h3>
                    
                    <!-- D3 Source Filter -->
                    <div class="mb-4 filter-group" data-filter-key="d3_source">
                        <details class="text-white/90" open>
                            <summary>Nguồn gốc D3</summary>
                            <div class="space-y-2 pt-2 pl-4">
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="checkbox" value="Động vật" class="rounded text-purple-500 focus:ring-purple-500">
                                    <span>Động vật (Lanolin)</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="checkbox" value="Thực vật" class="rounded text-purple-500 focus:ring-purple-500">
                                    <span>Thực vật (Tảo,...)</span>
                                </label>
                            </div>
                        </details>
                    </div>

                    <!-- K2 Content Filter -->
                    <div class="mb-4 filter-group" data-filter-key="has_k2">
                         <details class="text-white/90" open>
                            <summary>Thành Phần K2</summary>
                            <div class="space-y-2 pt-2 pl-4">
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="radio" name="k2_filter" value="all" class="text-purple-500 focus:ring-purple-500" checked>
                                    <span>Tất cả</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="radio" name="k2_filter" value="true" class="text-purple-500 focus:ring-purple-500">
                                    <span>Có Vitamin K2</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="radio" name="k2_filter" value="false" class="text-purple-500 focus:ring-purple-500">
                                    <span>Chỉ có D3</span>
                                </label>
                            </div>
                        </details>
                    </div>

                    <!-- D3 Content Filter -->
                    <div class="mb-4 filter-group" data-filter-key="d3_content">
                        <details class="text-white/90" open>
                            <summary>Hàm lượng D3</summary>
                            <div class="space-y-2 pt-2 pl-4">
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="checkbox" value="<100" class="rounded text-purple-500 focus:ring-purple-500">
                                    <span>Dưới 100 IU/Liều</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="checkbox" value="100-200" class="rounded text-purple-500 focus:ring-purple-500">
                                    <span>100-200 IU/Liều</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="checkbox" value="200-400" class="rounded text-purple-500 focus:ring-purple-500">
                                    <span>200-400 IU/Liều</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                    <input type="checkbox" value=">400" class="rounded text-purple-500 focus:ring-purple-500">
                                    <span>Trên 400 IU/Liều</span>
                                </label>
                            </div>
                        </details>
                    </div>

                    <!-- Origin Filter -->
                    <div class="mb-4 filter-group" data-filter-key="country">
                        <details class="text-white/90">
                            <summary>Xuất Xứ</summary>
                            <div class="space-y-2 pt-2" id="origin-filter">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </details>
                    </div>

                    <!-- Clear Filters Button -->
                    <button id="clear-filters" class="w-full mt-4 px-4 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-300">
                        Xóa Bộ Lọc
                    </button>
                </div>
            </aside>

            <!-- Products Grid -->
            <main class="w-full lg:w-3/4" id="products">
                 <h2 class="text-4xl font-bold text-white text-center mb-8">
                    Sản phẩm Hỗ trợ Xương, Răng & Chiều cao
                </h2>
                <!-- Search and Sort -->
                <div class="glass-effect p-6 rounded-3xl mb-8 fade-in">
                    <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                        <div class="relative flex-1 max-w-md w-full">
                            <input type="text" id="search-input" placeholder="Tìm kiếm sản phẩm..." 
                                   class="w-full px-4 py-3 pl-12 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <div class="flex items-center space-x-4">
                            <select id="sort-select" class="px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="name">Sắp xếp theo tên</option>
                                <option value="price_low">Giá thấp đến cao</option>
                                <option value="price_high">Giá cao đến thấp</option>
                                <option value="rating">Đánh giá cao nhất</option>
                            </select>
                            <div id="product-count" class="text-white/80 font-medium"></div>
                        </div>
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Products will be inserted here by JavaScript -->
                </div>

                <!-- No Results -->
                <div id="no-results" class="hidden text-center py-16">
                    <div class="glass-effect p-12 rounded-3xl">
                        <svg class="mx-auto h-16 w-16 text-white/60 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <h3 class="text-2xl font-bold text-white mb-2">Không tìm thấy sản phẩm</h3>
                        <p class="text-white/70">Vui lòng thử lại với bộ lọc khác hoặc từ khóa tìm kiếm khác.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparison-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-effect max-w-6xl w-full rounded-3xl p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-3 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    So Sánh Sản Phẩm
                </h3>
                <button id="comparison-close" class="text-white/60 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="comparison-content" class="comparison-table">
                <!-- Comparison table will be generated here -->
            </div>
        </div>
    </div>

    <!-- AI Consultation Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-effect max-w-2xl w-full rounded-3xl p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-3 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Tư Vấn AI Miễn Phí
                </h3>
                <button id="ai-close" class="text-white/60 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="ai-content">
                <div class="space-y-4 mb-6">
                    <div class="p-4 bg-white/10 rounded-xl">
                        <label class="block text-white/90 font-medium mb-2">Tuổi của bé:</label>
                        <select id="child-age" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">Chọn độ tuổi</option>
                            <option value="0-6months">0-6 tháng</option>
                            <option value="6-12months">6-12 tháng</option>
                            <option value="1-3years">1-3 tuổi</option>
                            <option value="3-12years">3-12 tuổi</option>
                        </select>
                    </div>
                    
                    <div class="p-4 bg-white/10 rounded-xl">
                        <label class="block text-white/90 font-medium mb-2">Ngân sách:</label>
                        <select id="budget" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">Chọn ngân sách</option>
                            <option value="under300">Dưới 300,000đ</option>
                            <option value="300-400">300,000đ - 400,000đ</option>
                            <option value="over400">Trên 400,000đ</option>
                        </select>
                    </div>
                    
                    <div class="p-4 bg-white/10 rounded-xl">
                        <label class="block text-white/90 font-medium mb-2">Ưu tiên:</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer text-white/80">
                                <input type="checkbox" value="organic" class="rounded text-emerald-500 focus:ring-emerald-500">
                                <span>Thành phần tự nhiên</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer text-white/80">
                                <input type="checkbox" value="european" class="rounded text-emerald-500 focus:ring-emerald-500">
                                <span>Xuất xứ châu Âu</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer text-white/80">
                                <input type="checkbox" value="k2" class="rounded text-emerald-500 focus:ring-emerald-500">
                                <span>Có vitamin K2</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer text-white/80">
                                <input type="checkbox" value="highrating" class="rounded text-emerald-500 focus:ring-emerald-500">
                                <span>Đánh giá cao</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button id="get-recommendation" class="w-full px-6 py-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center space-x-2">
                    <span>Nhận Tư Vấn Ngay</span>
                    <div id="ai-loading" class="hidden spinner"></div>
                </button>
                
                <div id="ai-result" class="hidden mt-6 p-6 bg-white/10 rounded-xl">
                    <!-- AI recommendation will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification glass-effect p-4 rounded-xl text-white">
        <div class="flex items-center space-x-3">
            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="notification-text">Đã thêm vào danh sách so sánh</span>
        </div>
    </div>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        // Enhanced product database with 20 products including ratings and reviews
        const products = [
            {
                id: 1, name: 'LineaBon K2+D3', brand: 'ErgoPharm', image: 'https://placehold.co/300x300/667eea/white?text=LineaBon', price: 295000,
                volume_ml: 10, total_doses_per_bottle: 300, origin: {country: 'Slovenia', continent: 'Châu Âu'}, form: 'drops',
                declared_dose: { unit_count: 6, unit_name: 'giọt', d3_iu: 400, k2_mcg: 22.5 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 6, max: 6, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 6, max: 8, unit: 'giọt' }, 'tu_3_den_12_tuoi': { min: 8, max: 12, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu Olive', additives: 'Tự nhiên' },
                rating: 4.8, reviews: 156, product_url: 'https://lineabon.vn/'
            },
            {
                id: 2, name: 'BioAmicus Vitamin D3 K2-MK7', brand: 'BioAmicus', image: 'https://placehold.co/300x300/764ba2/white?text=BioAmicus', price: 330000,
                volume_ml: 10, total_doses_per_bottle: 350, origin: {country: 'Canada', continent: 'Châu Mỹ'}, form: 'drops',
                declared_dose: { unit_count: 1, unit_name: 'giọt', d3_iu: 100, k2_mcg: 4 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 3, max: 4, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 7, max: 7, unit: 'giọt' }, 'tu_3_den_12_tuoi': { min: 10, max: 10, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 4.6, reviews: 89, product_url: 'https://bioamicus.vn/'
            },
            {
                id: 3, name: 'Dimao Pro Vitamin D3 - K2', brand: 'Dimao', image: 'https://placehold.co/300x300/10b981/white?text=Dimao', price: 299000,
                volume_ml: 25, total_doses_per_bottle: 125, origin: {country: 'Slovenia', continent: 'Châu Âu'}, form: 'spray',
                declared_dose: { unit_count: 1, unit_name: 'xịt', d3_iu: 400, k2_mcg: 18.75 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 1, max: 1, unit: 'xịt' }, 'tu_1_den_3_tuoi': { min: 1, max: 2, unit: 'xịt' }, 'tu_3_den_12_tuoi': { min: 2, max: 3, unit: 'xịt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu Olive', additives: 'Tổng hợp' },
                rating: 4.7, reviews: 134, product_url: 'https://dimao.vn/'
            },
            {
                id: 4, name: 'Sunday Natural D3+K2 MK7 Vegan', brand: 'Sunday Natural', image: 'https://placehold.co/300x300/f59e0b/white?text=Sunday+Natural', price: 450000,
                volume_ml: 20, total_doses_per_bottle: 600, origin: {country: 'Đức', continent: 'Châu Âu'}, form: 'drops',
                declared_dose: { unit_count: 1, unit_name: 'giọt', d3_iu: 200, k2_mcg: 15 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 2, max: 2, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 3, max: 4, unit: 'giọt' }, 'tu_3_den_12_tuoi': { min: 5, max: 5, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Thực vật', has_k2: true, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 4.9, reviews: 203, product_url: '#'
            },
            {
                id: 5, name: 'Pediakid Vitamin D3', brand: 'Pediakid', image: 'https://placehold.co/300x300/3b82f6/white?text=Pediakid', price: 250000,
                volume_ml: 20, total_doses_per_bottle: 400, origin: {country: 'Pháp', continent: 'Châu Âu'}, form: 'drops',
                declared_dose: { unit_count: 2, unit_name: 'giọt', d3_iu: 400, k2_mcg: 0 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 2, max: 2, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 2, max: 2, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: false, carrier_oil: 'Dầu hướng dương', additives: 'Tự nhiên' },
                rating: 4.4, reviews: 78, product_url: '#'
            },
            {
                id: 6, name: 'Kids Smart Drops D3+K2', brand: 'Nature\'s Way', image: 'https://placehold.co/300x300/8b5cf6/white?text=Nature%27s+Way+D3K2', price: 280000,
                volume_ml: 20, total_doses_per_bottle: 400, origin: {country: 'Úc', continent: 'Châu Úc'}, form: 'drops',
                declared_dose: { unit_count: 2, unit_name: 'giọt', d3_iu: 400, k2_mcg: 25 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 6, max: 6, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 6, max: 8, unit: 'giọt' }, 'tu_3_den_12_tuoi': { min: 8, max: 12, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 4.7, reviews: 167, product_url: '#'
            },
            {
                id: 7, name: 'Kids Smart Drops Vitamin D3', brand: 'Nature\'s Way', image: 'https://placehold.co/300x300/ec4899/white?text=Nature%27s+Way+D3', price: 220000,
                volume_ml: 20, total_doses_per_bottle: 400, origin: {country: 'Úc', continent: 'Châu Úc'}, form: 'drops',
                declared_dose: { unit_count: 1, unit_name: 'giọt', d3_iu: 400, k2_mcg: 0 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 1, max: 1, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 1, max: 1, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: false, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 4.3, reviews: 92, product_url: '#'
            },
            {
                id: 8, name: 'Baby\'s Vitamin D3', brand: 'Nordic Naturals', image: 'https://placehold.co/300x300/06b6d4/white?text=Nordic+Naturals', price: 350000,
                volume_ml: 11, total_doses_per_bottle: 365, origin: {country: 'Mỹ', continent: 'Châu Mỹ'}, form: 'drops',
                declared_dose: { unit_count: 1, unit_name: 'giọt', d3_iu: 400, k2_mcg: 0 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 1, max: 1, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 1, max: 1, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: false, carrier_oil: 'Dầu Olive', additives: 'Tự nhiên' },
                rating: 4.8, reviews: 245, product_url: '#'
            },
            {
                id: 9, name: 'Fitobimbi D3 + K2', brand: 'Pharmalife Research', image: 'https://placehold.co/300x300/84cc16/white?text=Fitobimbi', price: 290000,
                volume_ml: 30, total_doses_per_bottle: 600, origin: {country: 'Ý', continent: 'Châu Âu'}, form: 'drops',
                declared_dose: { unit_count: 5, unit_name: 'giọt', d3_iu: 400, k2_mcg: 45 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 5, max: 20, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 10, max: 30, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu đậu nành + Vitamin E', additives: 'Tự nhiên' },
                rating: 4.6, reviews: 112, product_url: '#'
            },
            {
                id: 11, name: 'Ocean D3K2 Spray', brand: 'ORZAX', image: 'https://placehold.co/300x300/0ea5e9/white?text=Ocean', price: 295000,
                volume_ml: 20, total_doses_per_bottle: 133, origin: {country: 'Thổ Nhĩ Kỳ', continent: 'Châu Á'}, form: 'spray',
                declared_dose: { unit_count: 1, unit_name: 'xịt', d3_iu: 400, k2_mcg: 22.5 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 1, max: 1, unit: 'xịt' }, 'tu_1_den_3_tuoi': { min: 1, max: 1, unit: 'xịt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 4.4, reviews: 89, product_url: '#'
            },
            {
                id: 12, name: 'Baby Drop D3 K2', brand: 'Herbitech', image: 'https://placehold.co/300x300/22c55e/white?text=Baby+Drop', price: 325000,
                volume_ml: 10, total_doses_per_bottle: 200, origin: {country: 'Việt Nam', continent: 'Châu Á'}, form: 'drops',
                declared_dose: { unit_count: 2, unit_name: 'giọt', d3_iu: 400, k2_mcg: 15 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 2, max: 4, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 6, max: 6, unit: 'giọt' }, 'tu_3_den_12_tuoi': { min: 8, max: 8, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu hướng dương', additives: 'Tự nhiên' },
                rating: 4.2, reviews: 45, product_url: '#'
            },
            {
                id: 15, name: 'Hibon Vitamin D3K2 Infant', brand: 'Hibon', image: 'https://placehold.co/300x300/8b5cf6/white?text=Hibon', price: 290000,
                volume_ml: 10, total_doses_per_bottle: 250, origin: {country: 'Ba Lan', continent: 'Châu Âu'}, form: 'drops',
                declared_dose: { unit_count: 4, unit_name: 'giọt', d3_iu: 400, k2_mcg: 10 },
                dosage_recommendation: { 'duoi_1_tuoi': { min: 3, max: 4, unit: 'giọt' }, 'tu_1_den_3_tuoi': { min: 5, max: 8, unit: 'giọt' }, 'tu_3_den_12_tuoi': { min: 8, max: 10, unit: 'giọt' } },
                ingredients_details: { d3_source: 'Động vật', has_k2: true, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 4.3, reviews: 78, product_url: '#'
            },
             {
                id: 16, name: 'Sunday Natural D3 1000 IU', brand: 'Sunday Natural', image: 'https://placehold.co/300x300/f59e0b/white?text=Sunday+D3', price: 350000,
                volume_ml: 50, total_doses_per_bottle: 1750, origin: {country: 'Đức', continent: 'Châu Âu'}, form: 'drops',
                declared_dose: { unit_count: 1, unit_name: 'giọt', d3_iu: 1000, k2_mcg: 0 },
                dosage_recommendation: { 'tu_3_den_12_tuoi': { min: 1, max: 1, unit: 'giọt' } }, // Adjusted, high dose
                ingredients_details: { d3_source: 'Động vật', has_k2: false, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 4.9, reviews: 310, product_url: 'https://sunday.vn/products/vitamin-d3-1000-iu-1750-giot-thuan-chay'
            },
            {
                id: 17, name: 'Sunday Natural D3+K2 MK7 1000 IU', brand: 'Sunday Natural', image: 'https://placehold.co/300x300/f59e0b/white?text=Sunday+D3K2', price: 420000,
                volume_ml: 10, total_doses_per_bottle: 300, origin: {country: 'Đức', continent: 'Châu Âu'}, form: 'drops',
                declared_dose: { unit_count: 1, unit_name: 'giọt', d3_iu: 1000, k2_mcg: 50 },
                dosage_recommendation: { 'tu_3_den_12_tuoi': { min: 1, max: 1, unit: 'giọt' } }, // Adjusted, high dose
                ingredients_details: { d3_source: 'Thực vật', has_k2: true, carrier_oil: 'Dầu MCT', additives: 'Tự nhiên' },
                rating: 5.0, reviews: 150, product_url: 'https://sunday.vn/products/vitamin-d3-k2-mk7-1000-iu-50%C2%B5g-thuan-chay-300-giot'
            }
        ];

        // Global variables
        let filteredProducts = [...products];
        let activeFilters = {};
        let selectedProducts = [];

        // Initialize the application
        function initializeApp() {
            initializeFilters();
            renderProducts(products);
            setupEventListeners();
            updateProductCount(products.length);
        }

        // Initialize filters
        function initializeFilters() {
            // Populate origin filter
            const originFilter = document.getElementById('origin-filter');
            const originsByContinent = products.reduce((acc, p) => {
                if (!acc[p.origin.continent]) {
                    acc[p.origin.continent] = new Set();
                }
                acc[p.origin.continent].add(p.origin.country);
                return acc;
            }, {});

            originFilter.innerHTML = Object.keys(originsByContinent).sort().map(continent => `
                <details class="text-white/90">
                    <summary>${continent}</summary>
                    <div class="space-y-2 pt-2 pl-4">
                        ${[...originsByContinent[continent]].sort().map(country => `
                            <label class="flex items-center space-x-3 cursor-pointer text-white/80 hover:text-white transition-colors font-normal">
                                <input type="checkbox" value="${country}" class="rounded text-purple-500 focus:ring-purple-500">
                                <span>${country}</span>
                            </label>
                        `).join('')}
                    </div>
                </details>
            `).join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('search-input').addEventListener('input', handleSearch);
            
            // Sort functionality
            document.getElementById('sort-select').addEventListener('change', handleSort);
            
            // Filter functionality
            document.addEventListener('change', function(e) {
                if (e.target.type === 'checkbox' || e.target.type === 'radio') {
                    handleFilterChange();
                }
            });
            
            // Clear filters
            document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
            
            // Comparison functionality
            const compareMenu = document.getElementById('compare-menu-container');
            compareMenu.addEventListener('click', (e) => {
                if(e.target.closest('#compare-btn')) {
                    document.getElementById('compare-dropdown').classList.toggle('hidden');
                }
                if(e.target.dataset.compareType) {
                    e.preventDefault();
                    showComparison(e.target.dataset.compareType);
                    document.getElementById('compare-dropdown').classList.add('hidden');
                }
            });

            document.getElementById('comparison-close').addEventListener('click', () => {
                document.getElementById('comparison-modal').classList.add('hidden');
            });
            
            // AI consultation modal
            const aiConsultBtn = document.getElementById('ai-consult-btn');
            if (aiConsultBtn) {
                 aiConsultBtn.addEventListener('click', () => {
                    document.getElementById('ai-modal').classList.remove('hidden');
                });
            }
            
            const aiCloseBtn = document.getElementById('ai-close');
            if(aiCloseBtn) {
                aiCloseBtn.addEventListener('click', () => {
                    document.getElementById('ai-modal').classList.add('hidden');
                });
            }
           
            const aiModal = document.getElementById('ai-modal');
            if(aiModal){
                 aiModal.addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        aiModal.classList.add('hidden');
                    }
                });
            }

            const getRecommendationBtn = document.getElementById('get-recommendation');
            if(getRecommendationBtn){
                 getRecommendationBtn.addEventListener('click', getAIRecommendation);
            }
            
            // Close modals on backdrop click
            document.getElementById('comparison-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('comparison-modal').classList.add('hidden');
                }
            });
        }

        // Handle search
        function handleSearch(e) {
            applyFilters();
        }

        // Handle sort
        function handleSort(e) {
            applyFilters();
        }

        // Handle filter changes
        function handleFilterChange() {
            applyFilters();
        }

        // Apply all filters
        function applyFilters() {
            let filtered = [...products];
            
            // Search filter
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.brand.toLowerCase().includes(searchTerm) ||
                    product.origin.country.toLowerCase().includes(searchTerm)
                );
            }
            
            // D3 Source filter
            const d3Sources = Array.from(document.querySelectorAll('[data-filter-key="d3_source"] input:checked')).map(cb => cb.value);
            if (d3Sources.length > 0) {
                filtered = filtered.filter(p => d3Sources.includes(p.ingredients_details.d3_source));
            }

            // K2 filter
            const k2Filter = document.querySelector('input[name="k2_filter"]:checked').value;
            if (k2Filter !== 'all') {
                const hasK2 = k2Filter === 'true';
                filtered = filtered.filter(product => product.ingredients_details.has_k2 === hasK2);
            }
            
            // D3 Content filter
            const d3ContentRanges = Array.from(document.querySelectorAll('[data-filter-key="d3_content"] input:checked')).map(cb => cb.value);
            if (d3ContentRanges.length > 0) {
                filtered = filtered.filter(p => {
                    const d3PerDose = p.declared_dose.d3_iu / p.declared_dose.unit_count;
                    return d3ContentRanges.some(range => {
                        if (range === '<100') return d3PerDose < 100;
                        if (range === '100-200') return d3PerDose >= 100 && d3PerDose <= 200;
                        if (range === '200-400') return d3PerDose > 200 && d3PerDose <= 400;
                        if (range === '>400') return d3PerDose > 400;
                        return false;
                    });
                });
            }

            // Origin filter
            const origins = Array.from(document.querySelectorAll('[data-filter-key="country"] input:checked')).map(cb => cb.value);
            if (origins.length > 0) {
                filtered = filtered.filter(product => origins.includes(product.origin.country));
            }
            
            // Sort
            const sortBy = document.getElementById('sort-select').value;
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'price_low': return a.price - b.price;
                    case 'price_high': return b.price - a.price;
                    case 'rating': return b.rating - a.rating;
                    default: return 0;
                }
            });

            renderProducts(filtered);
            updateProductCount(filtered.length);
        }

        // Clear all filters
        function clearAllFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[type="radio"][value="all"]').forEach(radio => radio.checked = true);
            document.getElementById('search-input').value = '';
            document.getElementById('sort-select').value = 'name';
            
            applyFilters();
        }

        // Update product count
        function updateProductCount(count) {
            document.getElementById('product-count').textContent = `${count} sản phẩm`;
        }

        // Generate star rating HTML
        function generateStarRating(rating) {
            let stars = '';
            for(let i = 1; i <= 5; i++) {
                stars += `<span class="star ${i <= rating ? '' : 'empty'}">★</span>`;
            }
            return stars;
        }

        // Toggle product selection for comparison
        function toggleProductSelection(productId) {
            const index = selectedProducts.indexOf(productId);
            if (index > -1) {
                selectedProducts.splice(index, 1);
                showNotification('Đã xóa khỏi danh sách so sánh');
            } else {
                if (selectedProducts.length >= 4) {
                    showNotification('Chỉ có thể so sánh tối đa 4 sản phẩm', 'warning');
                    return;
                }
                selectedProducts.push(productId);
                showNotification('Đã thêm vào danh sách so sánh');
            }
            
            updateCompareButton();
            updateProductCards();
        }

        // Update compare button
        function updateCompareButton() {
            document.getElementById('compare-count').textContent = selectedProducts.length;
            const compareBtn = document.getElementById('compare-btn');
            if (selectedProducts.length > 1) {
                compareBtn.classList.remove('opacity-50');
                compareBtn.disabled = false;
            } else {
                compareBtn.classList.add('opacity-50');
                compareBtn.disabled = true;
            }
        }

        // Update product cards to show selection state
        function updateProductCards() {
            document.querySelectorAll('.product-card').forEach(card => {
                const productId = parseInt(card.dataset.productId);
                if (selectedProducts.includes(productId)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Show comparison modal
        function showComparison(type) {
            if (selectedProducts.length < 2) {
                showNotification('Vui lòng chọn ít nhất 2 sản phẩm để so sánh', 'warning');
                return;
            }
            
            const selectedProductsData = products.filter(p => selectedProducts.includes(p.id));
            
            if (type === 'dosage') {
                generateComparisonChart(selectedProductsData);
            } else if (type === 'cost') {
                // Placeholder for cost comparison chart
                document.getElementById('comparison-content').innerHTML = '<p class="text-white">Biểu đồ so sánh chi phí sắp ra mắt.</p>';
            } else if (type === 'k2') {
                // Placeholder for K2 comparison chart
                document.getElementById('comparison-content').innerHTML = '<p class="text-white">Biểu đồ so sánh K2 sắp ra mắt.</p>';
            }

            document.getElementById('comparison-modal').classList.remove('hidden');
        }

        // Generate comparison table
        function generateComparisonChart(productsToCompare) {
            const comparisonContent = document.getElementById('comparison-content');
            const ageGroups = [
                { label: 'Sơ Sinh (<1 tuổi)', key: 'duoi_1_tuoi' },
                { label: 'Trẻ nhỏ (1-3 tuổi)', key: 'tu_1_den_3_tuoi' },
                { label: 'Trẻ em (3-12 tuổi)', key: 'tu_3_den_12_tuoi' }
            ];

            let maxDose = 0;
            productsToCompare.forEach(p => {
                ageGroups.forEach(age => {
                    if (p.dosage_recommendation[age.key] && p.dosage_recommendation[age.key].max > maxDose) {
                        maxDose = p.dosage_recommendation[age.key].max;
                    }
                });
            });
            maxDose = maxDose > 0 ? maxDose : 1;

            let chartHtml = '<div class="space-y-8">';

            productsToCompare.forEach(product => {
                chartHtml += `
                    <div>
                        <div class="flex items-center mb-3">
                            <img src="${product.image}" alt="${product.name}" class="w-10 h-10 rounded-lg mr-3">
                            <h4 class="font-bold text-lg text-white">${product.name}</h4>
                        </div>
                        <div class="space-y-2">`;

                ageGroups.forEach(age => {
                    const dose = product.dosage_recommendation[age.key];
                    let barHtml;
                    if (dose) {
                        const barWidth = (dose.max / maxDose) * 100;
                        const doseText = dose.min === dose.max ? `${dose.min} ${dose.unit}` : `${dose.min}-${dose.max} ${dose.unit}`;
                        barHtml = `
                            <div class="flex-1 bg-white/10 rounded-full h-8">
                                <div class="comparison-bar bg-gradient-to-r from-emerald-500 to-teal-500 h-8 rounded-full text-white text-sm font-medium flex items-center justify-end pr-3" style="width: ${barWidth}%">
                                    <span>${doseText}</span>
                                </div>
                            </div>`;
                    } else {
                        barHtml = `<div class="flex-1 text-white/50 text-sm italic">Không khuyến nghị</div>`;
                    }

                    chartHtml += `
                        <div class="flex items-center gap-4">
                            <span class="w-32 text-sm text-white/80 text-right">${age.label}</span>
                            ${barHtml}
                        </div>`;
                });

                chartHtml += '</div></div>';
            });

            chartHtml += '</div>';
            comparisonContent.innerHTML = chartHtml;
        }

        // Render products
        function renderProducts(productsToRender) {
            const grid = document.getElementById('product-grid');
            const noResults = document.getElementById('no-results');
            
            if (productsToRender.length === 0) {
                grid.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            grid.innerHTML = productsToRender.map(product => {
                const doseInfo = product.dosage_recommendation.duoi_1_tuoi || product.dosage_recommendation.tu_1_den_3_tuoi;
                const dailyDose = doseInfo ? doseInfo.min : 1;
                const dailyCost = Math.round((product.price / product.total_doses_per_bottle) * dailyDose);

                return `
                <div class="glass-effect p-6 rounded-3xl card-hover fade-in product-card ${selectedProducts.includes(product.id) ? 'selected' : ''}" data-product-id="${product.id}">
                    <div class="relative mb-4">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover rounded-2xl">
                        <div class="absolute top-3 right-3">
                            <span class="px-3 py-1 bg-gradient-to-r from-emerald-500 to-teal-600 text-white text-xs font-semibold rounded-full">
                                ${product.origin.country}
                            </span>
                        </div>
                        ${product.ingredients_details.has_k2 ? 
                            '<div class="absolute top-3 left-3"><span class="px-2 py-1 bg-purple-500 text-white text-xs font-semibold rounded-full">K2</span></div>' : 
                            ''
                        }
                        <button onclick="toggleProductSelection(${product.id})" class="absolute bottom-3 right-3 w-8 h-8 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-white/30 transition-colors">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <h3 class="font-bold text-lg text-white mb-2 line-clamp-2 h-14">${product.name}</h3>
                    <p class="text-white/70 text-sm mb-3">${product.brand}</p>
                    
                    <div class="space-y-2 mb-4 border-t border-b border-white/10 py-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-white/70">Tổng liều:</span>
                            <span class="text-white font-medium">${product.total_doses_per_bottle} ${product.declared_dose.unit_name}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-white/70">Công bố D3:</span>
                            <span class="text-white font-medium">${product.declared_dose.d3_iu} IU / ${product.declared_dose.unit_count} ${product.declared_dose.unit_name}</span>
                        </div>
                        ${product.ingredients_details.has_k2 ? `
                        <div class="flex justify-between text-sm">
                            <span class="text-white/70">Công bố K2:</span>
                            <span class="text-white font-medium">${product.declared_dose.k2_mcg} mcg / ${product.declared_dose.unit_count} ${product.declared_dose.unit_name}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-auto">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-2xl font-bold text-white">${formatPrice(product.price)}</span>
                                <span class="text-white/70 text-sm">đ</span>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-emerald-400">${formatPrice(dailyCost)}đ</span>
                                <span class="text-xs text-white/70 block">/ ngày</span>
                            </div>
                        </div>
                        <a href="${product.product_url}" target="_blank" class="block w-full text-center mt-3 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-300 text-sm">
                            Đến nơi bán
                        </a>
                    </div>
                </div>
            `}).join('');
        }
        
        // --- Gemini AI Functions ---
        
        async function getAIRecommendation() {
            const ageEl = document.getElementById('child-age');
            const budgetEl = document.getElementById('budget');
            
            const age = ageEl.options[ageEl.selectedIndex].text;
            const budget = budgetEl.options[budgetEl.selectedIndex].text;
            const preferences = Array.from(document.querySelectorAll('#ai-content input[type="checkbox"]:checked'))
                                   .map(cb => cb.parentElement.textContent.trim());

            if (!ageEl.value || !budgetEl.value) {
                alert('Vui lòng chọn đầy đủ thông tin về tuổi và ngân sách của bé.');
                return;
            }

            // Show loading state
            const button = document.getElementById('get-recommendation');
            const loading = document.getElementById('ai-loading');
            const buttonText = button.querySelector('span');
            
            button.disabled = true;
            loading.classList.remove('hidden');
            buttonText.textContent = 'Đang phân tích...';

            const systemPrompt = "Bạn là một chuyên gia dinh dưỡng nhi khoa tại Việt Nam, am hiểu về các sản phẩm vitamin D3K2 trên thị trường. Nhiệm vụ của bạn là đưa ra lời khuyên ngắn gọn, dễ hiểu và thuyết phục cho các bà mẹ.";

            const userQuery = `
                Dựa vào danh sách sản phẩm sau đây:
                ${JSON.stringify(products, null, 2)}

                Hãy tư vấn cho một bà mẹ đang tìm sản phẩm vitamin cho con.
                Thông tin về bé:
                - Tuổi: ${age}
                - Ngân sách: ${budget}
                - Ưu tiên khác: ${preferences.join(', ') || 'Không có'}

                Yêu cầu:
                1.  Đề xuất 1 đến 3 sản phẩm phù hợp nhất.
                2.  Với mỗi sản phẩm, giải thích ngắn gọn (1-2 câu) tại sao nó phù hợp.
                3.  Đưa ra một lời khuyên cuối cùng thật tâm lý và hữu ích.
                4.  Trả lời hoàn toàn bằng tiếng Việt.
            `;
            
            try {
                const resultText = await callGeminiAPI(systemPrompt, userQuery);
                displayAIRecommendation(resultText);
            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                displayAIRecommendation("Rất tiếc, đã có lỗi xảy ra. Vui lòng thử lại sau.");
            } finally {
                // Reset button state
                button.disabled = false;
                loading.classList.add('hidden');
                buttonText.textContent = 'Nhận Tư Vấn Ngay';
            }
        }
        
        async function callGeminiAPI(systemInstruction, userQuery) {
            // In a real application, you should hide your API key.
            // For this example, we leave it as an empty string, and it will be handled by the execution environment.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
            }

            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "Không nhận được phản hồi từ AI.";
        }

        function displayAIRecommendation(text) {
            const resultDiv = document.getElementById('ai-result');
            // Basic markdown to HTML conversion
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                           .replace(/\n/g, '<br>');
            resultDiv.innerHTML = `<div class="text-white/90 leading-relaxed">${html}</div>`;
            resultDiv.classList.remove('hidden');
        }


        // Format price
        function formatPrice(price) {
            return price.toLocaleString('vi-VN');
        }
    </script>
</body>
</html>

